# Generated by the 'lockdown' ansible role:
# https://github.com/mjkelly/ansible-playbooks/tree/master/lockdown
*filter
:INPUT DROP [0:0]
:FORWARD {% if wireguard %}ACCEPT{% else %}DROP{% endif %} [0:0]
:OUTPUT ACCEPT [0:0]
:LOGGING - [0:0]
-A INPUT -i lo -j ACCEPT

# Allow already established connections
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
# Allow ping
-A INPUT -p icmp -m icmp --icmp-type echo-request -j ACCEPT
-A INPUT -p icmp -m icmp --icmp-type echo-reply -j ACCEPT

# User-configured open ports.
{% for port in open_ports %}
# Allow port {{ port.port }}/{{ port.proto }}
-A INPUT -p {{ port.proto }} -m {{ port.proto }} --dport {{ port.port }} -j ACCEPT
{% endfor %}
# End user-configured open ports.

{% if wireguard %}
# Allow wireguard.
-A INPUT -p udp -m udp --dport {{ wireguard_listen_port }} -j ACCEPT
{% endif %}

# Packet types to drop without logging. We do this because they're noisy in
# logs and uninteresting to us.
-A INPUT -m pkttype --pkt-type broadcast -j DROP

# Everything else is destined to be dropped. We log it first.
-A INPUT -j LOGGING

# On debian this will appear in /var/log/kern.log.
-A LOGGING -m limit --limit 10/min -j LOG --log-prefix "IPTables Drop: " --log-level 7
-A LOGGING -j DROP
COMMIT
